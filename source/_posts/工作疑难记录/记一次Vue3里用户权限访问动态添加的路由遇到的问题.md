---
title: 记一次Vue3里用户权限访问动态添加的路由遇到的问题
tags: 疑难记录
categories: 前端
date: 2023/10/18 22:14
---

# 记一次Vue3里用户权限访问动态添加的路由遇到的问题

## 背景

在开发生成式驾驶舱的用户管理和租户管理时，需要对之前的路由系统做改造。从之前固定访问所有路由，修改为根据用户的角色（当前比较简单，即：系统租户和普通租户，租户下只设管理员和普通用户）所能访问的菜单。

## 发现问题

第一想法就是在src/router/index.js里的router.beforeEach进行改造。

原先逻辑为从Pinia里获取用户token，判断没有token则跳转login页面，否则直接访问。因此需要在这里增加用户信息的获取，从用户信息里拿到角色，判断能否访问用户管理和租户管理。

因此将全量路由表修改为3部分：静态路由、404路由、受控路由。初始化createRouter时，添加静态路由和404路由，在beforeEach里用addRoute根据用户角色添加受控路由。

写完代码后正常访问都没问题，然而在用户管理页面直接刷新总是会跳转到首页。

## 解决问题

此时已经是6点10分，下班时间了，想着抓紧时间解决问题回家。

经过排查，发现在用户管理页面刷新页面，在beforeEach里，router.getRoutes()其实是不包含受控路由，而addRouter是同步执行，当获取完用户权限再打印router.getRoutes()，此时已经可以拿到包含受控路由在内的搜有路由了。但是此时next()，依然会触发VueRouter的报错。Google并没有获取很多有价值的参考信息，只有一条在V2ex上的帖子跟我的想法类似，说是不要使用next和return混合使用。

遂修改原先的return方式，改为在所有的ifelse分支判断里使用next进行导航，依然报错。

于是下班。

第二天。

一早来，先被叫去参加交流。中午吃完饭继续。此时想到导致问题的原因时，进入beforeEach之前，路由表不包含受控路由导致的问题，那么我在router.js里先获取用户信息，再组装路由是否可行。

说干就干，直接将await getUserInfo()写到createRouter()之前，刷新页面发现控制台报错，说是不能在pinia定义之前使用useAuthStore()。

这可难住我了，不停尝试调整main.js里加载pinia和router的时机，发现都无法解决问题。突然发现，问题的原因是import router的时候，就立刻执行了router.beforeEach，如果此时先获取用户信息，再进行路由守卫，那么进入守卫的路由表不就是完整的了么。

于是，添加promise函数initRouter，封装router.beforeEach，并在main.js里调用initRouter，在then里挂载到app上。刷新页面，问题解决！然后在退出账号，尝试重定向到用户管理时，发现控制台报错，说没有该路由。郁闷了。

先睡午觉。

躺在午休床上，突然想到刚刚的问题，是因为之前是local storage有token，所以直接刷新没问题，现在是登录后报错，说没有受控路由。那是因为我只在main.js里使用了addRouter添加动态路由，而没有在点击登录后添加。所以有问题。

好了可以安心睡觉了，睡醒直接添加代码，再重试，解决问题～

